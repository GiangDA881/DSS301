-- X√≥a c√°c b·∫£ng c≈© n·∫øu ch√∫ng t·ªìn t·∫°i ƒë·ªÉ ch·∫°y l·∫°i file script (T·ªët cho l·∫≠p tr√¨nh)
DROP TABLE IF EXISTS order_items CASCADE;
DROP TABLE IF EXISTS orders CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS revenue_trends CASCADE;
DROP TABLE IF EXISTS demand_forecasts CASCADE;
DROP TABLE IF EXISTS campaign_proposals CASCADE;
DROP TABLE IF EXISTS customer_predictions CASCADE;
DROP TABLE IF EXISTS sales_summary CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS customers CASCADE;

-- =======================================================
-- üîπ D·ªØ li·ªáu G·ªëc (OLTP) - D√πng cho CRUD & T√≠nh nƒÉng B·ªï sung
-- =======================================================

-- B·∫£ng Customers
CREATE TABLE customers (
    customer_id VARCHAR(20) PRIMARY KEY,
    customer_name VARCHAR(100),
    country VARCHAR(100),
    region VARCHAR(100),
    email VARCHAR(100),
    gender VARCHAR(10),
    age INT
);

-- B·∫£ng Products
CREATE TABLE products (
    stock_code VARCHAR(20) PRIMARY KEY,
    description VARCHAR(255),
    category VARCHAR(100),
    unit_price DECIMAL(10, 2)
);

-- B·∫£ng Users (Chu·∫©n PostgreSQL & Spring Security)
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY, -- ƒê·ªïi t·ª´ AUTO_INCREMENT sang SERIAL
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL, -- Spring Security s·∫Ω hash
    role VARCHAR(50) NOT NULL, -- B·ªè ENUM, d√πng VARCHAR
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- B·∫£ng Orders (Ti√™u ƒë·ªÅ ƒë∆°n h√†ng - Chu·∫©n PostgreSQL)
CREATE TABLE orders (
    order_id VARCHAR(20) PRIMARY KEY,
    customer_id VARCHAR(20) NOT NULL,
    order_date DATE NOT NULL,
    status VARCHAR(50) DEFAULT 'Pending', -- B·ªè ENUM, d√πng VARCHAR
    subtotal DECIMAL(10, 2) DEFAULT 0,
    tax DECIMAL(10, 2) DEFAULT 0,
    shipping_fee DECIMAL(10, 2) DEFAULT 0,
    total_amount DECIMAL(10, 2) DEFAULT 0,
    payment_method VARCHAR(50),
    shipping_address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- B·ªè "ON UPDATE" (Spring Boot s·∫Ω x·ª≠ l√Ω)
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);

-- B·∫£ng Order_Items (Chi ti·∫øt ƒë∆°n h√†ng - Chu·∫©n PostgreSQL)
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY, -- ƒê·ªïi t·ª´ AUTO_INCREMENT sang SERIAL
    order_id VARCHAR(20) NOT NULL,
    product_id VARCHAR(20) NOT NULL,
    quantity INT DEFAULT 1,
    unit_price DECIMAL(10, 2) DEFAULT 0,
    -- B·ªè "GENERATED ALWAYS AS" (Spring Boot/Service s·∫Ω t·ª± t√≠nh)
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(stock_code)
);

-- =======================================================
-- üîπ D·ªØ li·ªáu Ph√¢n t√≠ch (OLAP/Data Mart) - D√πng cho DSS
-- =======================================================

-- B·∫£ng T√≥m t·∫Øt B√°n h√†ng
CREATE TABLE sales_summary (
    id SERIAL PRIMARY KEY, -- Th√™m PK cho b·∫£ng n√†y
    country VARCHAR(100),
    stock_code VARCHAR(20),
    total_quantity INT,
    total_revenue DECIMAL(12, 2),
    ranking INT,
    analysis_date DATE,
    FOREIGN KEY (stock_code) REFERENCES products(stock_code)
);

-- B·∫£ng D·ª± ƒëo√°n Kh√°ch h√†ng (RFM, Churn)
CREATE TABLE customer_predictions (
    id SERIAL PRIMARY KEY, -- Th√™m PK cho b·∫£ng n√†y
    customer_id VARCHAR(20),
    recency INT,
    frequency INT,
    monetary DECIMAL(12, 2),
    repurchase_probability DECIMAL(5, 2),
    prediction_date DATE,
    segment VARCHAR(50),
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);

-- B·∫£ng ƒê·ªÅ xu·∫•t Chi·∫øn d·ªãch (C·ªßa b·∫°n)
CREATE TABLE campaign_proposals (
    campaign_id SERIAL PRIMARY KEY, -- ƒê·ªïi t·ª´ AUTO_INCREMENT sang SERIAL
    campaign_name VARCHAR(100),
    target_segment VARCHAR(50),
    expected_cost DECIMAL(12, 2),
    expected_revenue DECIMAL(12, 2),
    roi DECIMAL(5, 2),
    created_at DATE
);

-- B·∫£ng D·ª± b√°o Nhu c·∫ßu (Inventory)
CREATE TABLE demand_forecasts (
    forecast_id SERIAL PRIMARY KEY, -- ƒê·ªïi t·ª´ AUTO_INCREMENT sang SERIAL
    category VARCHAR(100),
    forecast_date DATE,
    actual_sales DECIMAL(12, 2),
    predicted_sales DECIMAL(12, 2),
    forecast_model VARCHAR(50)
);

-- B·∫£ng Xu h∆∞·ªõng Doanh thu (Sales)
CREATE TABLE revenue_trends (
    id SERIAL PRIMARY KEY, -- Th√™m PK cho b·∫£ng n√†y
    period VARCHAR(20),
    total_revenue DECIMAL(12, 2),
    growth_rate DECIMAL(5, 2),
    recorded_at DATE
);