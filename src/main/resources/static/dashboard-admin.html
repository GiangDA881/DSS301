<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DSS301</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .navbar {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .role-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .logout-btn {
            background: white;
            color: #dc3545;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .menu-list {
            list-style: none;
            padding: 0;
        }

        .menu-list li {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-list li:hover {
            background: #dc3545;
            color: white;
            transform: translateX(10px);
        }

        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .btn-action {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 5px 0;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-action:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc3545;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-box {
            background: #d4edda;
            border: 1px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .error-box.show {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div>
                <h2>üëë Admin Dashboard</h2>
            </div>
            <div class="user-info">
                <span class="role-badge">ADMIN</span>
                <span id="userDisplay">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <div class="card">
                <h2>ÔøΩ Data Jobs</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Qu·∫£n l√Ω v√† th·ª±c thi c√°c c√¥ng vi·ªác x·ª≠ l√Ω d·ªØ li·ªáu
                </p>
                <button class="btn-action" onclick="window.location.href='/data-job.html'" style="background: #17a2b8;">
                    üöÄ M·ªü Data Job Manager
                </button>
            </div>
        </div>
    </div>

    <script>
        // Check authentication and role
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');
        const token = localStorage.getItem('token');

        if (!token || !username) {
            window.location.href = '/login.html';
        } else if (role !== 'Admin') {
            alert('Access Denied: Admin only!');
            window.location.href = '/login.html';
        } else {
            document.getElementById('userDisplay').textContent = `üë§ ${username}`;
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // ========================================
        // CH·∫†Y PH√ÇN T√çCH RFM
        // ========================================
        async function runRfmAnalysis() {
            const btn = document.getElementById('btnRfm');
            const resultBox = document.getElementById('rfmResult');
            const errorBox = document.getElementById('rfmError');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ƒêang ph√¢n t√≠ch...';
            resultBox.classList.remove('show');
            errorBox.classList.remove('show');
            
            try {
                const response = await fetch('/marketing/analysis/api/run-rfm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error('API tr·∫£ v·ªÅ l·ªói: ' + response.statusText);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    resultBox.innerHTML = `
                        <strong>‚úÖ Ph√¢n t√≠ch th√†nh c√¥ng!</strong><br>
                        üìä ƒê√£ ph√¢n t√≠ch: <strong>${result.recordsSaved}</strong> kh√°ch h√†ng<br>
                        ‚è±Ô∏è Th·ªùi gian: <strong>${result.durationSeconds.toFixed(2)}s</strong>
                    `;
                    resultBox.classList.add('show');
                    
                    // C·∫≠p nh·∫≠t ho·∫°t ƒë·ªông
                    addActivity('üìä Ph√¢n t√≠ch RFM ho√†n t·∫•t - ' + result.recordsSaved + ' kh√°ch h√†ng');
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('L·ªói:', error);
                errorBox.innerHTML = `<strong>‚ùå L·ªói:</strong> ${error.message}`;
                errorBox.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Ch·∫°y ph√¢n t√≠ch RFM';
            }
        }

        // ========================================
        // KI·ªÇM TRA TR·∫†NG TH√ÅI API
        // ========================================
        async function checkApiStatus() {
            const btn = document.getElementById('btnStatus');
            const resultBox = document.getElementById('statusResult');
            const errorBox = document.getElementById('statusError');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ƒêang ki·ªÉm tra...';
            resultBox.classList.remove('show');
            errorBox.classList.remove('show');
            
            try {
                const response = await fetch('/marketing/analysis/api/status');
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn API');
                }
                
                const status = await response.json();
                
                resultBox.innerHTML = `
                    <strong>‚úÖ H·ªá th·ªëng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</strong><br>
                    üîß Service: <strong>${status.service}</strong><br>
                    ‚úì Status: <strong>${status.status}</strong><br>
                    üìù ${status.description}
                `;
                resultBox.classList.add('show');
                
            } catch (error) {
                console.error('L·ªói:', error);
                errorBox.innerHTML = `<strong>‚ùå L·ªói:</strong> ${error.message}`;
                errorBox.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Ki·ªÉm tra tr·∫°ng th√°i';
            }
        }

        // ========================================
        // XEM PH√ÇN KH√öC
        // ========================================
        async function viewSegments() {
            try {
                const response = await fetch('/campaign/api/segments');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i segments');
                
                const segments = await response.json();
                
                if (segments.length === 0) {
                    alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n kh√∫c.\nVui l√≤ng ch·∫°y "Ph√¢n t√≠ch RFM" tr∆∞·ªõc!');
                } else {
                    const segmentList = segments.map((s, i) => `${i + 1}. ${s}`).join('\n');
                    alert(`üìä Ph√¢n kh√∫c kh√°ch h√†ng hi·ªán c√≥ (${segments.length}):\n\n${segmentList}`);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // ========================================
        // XEM D·ª∞ B√ÅO KH√ÅCH H√ÄNG
        // ========================================
        function viewPredictions() {
            alert('üîÑ Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn\n\nB·∫°n c√≥ th·ªÉ ki·ªÉm tra d·ªØ li·ªáu trong database:\nB·∫£ng: customer_predictions');
        }

        // ========================================
        // XEM CHI·∫æN D·ªäCH
        // ========================================
        function viewCampaigns() {
            alert('üîÑ Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn\n\nB·∫°n c√≥ th·ªÉ ki·ªÉm tra d·ªØ li·ªáu trong database:\nB·∫£ng: campaign_proposals');
        }

        // ========================================
        // XU·∫§T D·ªÆ LI·ªÜU
        // ========================================
        function exportData() {
            alert('üì• Ch·ª©c nƒÉng xu·∫•t d·ªØ li·ªáu ƒëang ph√°t tri·ªÉn\n\nHi·ªán t·∫°i b·∫°n c√≥ th·ªÉ:\n- Truy v·∫•n tr·ª±c ti·∫øp t·ª´ PostgreSQL\n- S·ª≠ d·ª•ng pgAdmin ƒë·ªÉ export CSV/Excel');
        }

        // ========================================
        // TH√äM HO·∫†T ƒê·ªòNG
        // ========================================
        function addActivity(message) {
            const container = document.getElementById('recentActivities');
            const time = new Date().toLocaleTimeString('vi-VN');
            const activity = document.createElement('div');
            activity.className = 'alert';
            activity.innerHTML = `üïê ${time} - ${message}`;
            
            // Th√™m v√†o ƒë·∫ßu
            if (container.firstChild) {
                container.insertBefore(activity, container.firstChild);
            } else {
                container.appendChild(activity);
            }
            
            // Gi·ªõi h·∫°n 5 ho·∫°t ƒë·ªông
            const activities = container.querySelectorAll('.alert');
            if (activities.length > 5) {
                container.removeChild(activities[activities.length - 1]);
            }
        }

        // ========================================
        // INIT - LOAD HO·∫†T ƒê·ªòNG M·∫™U
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('recentActivities');
            container.innerHTML = `
                <div class="alert">‚úÖ H·ªá th·ªëng kh·ªüi ƒë·ªông th√†nh c√¥ng</div>
                <div class="alert">üë§ Admin ${username} ƒë√£ ƒëƒÉng nh·∫≠p</div>
            `;
        });
    </script>
</body>
</html>
